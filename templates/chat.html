<!DOCTYPE html>
<html lang="{{ session.get('lang', 'en') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t.chat_title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .chat-sidebar::-webkit-scrollbar { width: 4px; }
        .chat-sidebar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .chat-body::-webkit-scrollbar { width: 6px; }
        .chat-body::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .typing-cursor::after { content: '‚ñç'; animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white flex flex-col p-4 chat-sidebar">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-xl font-bold">{{ t.my_chats }}</h1>
                <div class="text-xs">
                    <a href="/set_language/en" class="{{ 'text-white font-bold' if session.get('lang', 'en') == 'en' else 'text-gray-400' }}">EN</a>
                    <span class="text-gray-500">|</span>
                    <a href="/set_language/or" class="{{ 'text-white font-bold' if session.get('lang', 'en') == 'or' else 'text-gray-400' }}">OR</a>
                </div>
            </div>
            <a href="{{ url_for('ehr_page') }}" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg mb-2 text-center">
                <i class="fas fa-file-medical mr-2"></i>{{ t.my_health_record_link }}
            </a>
            <a href="{{ url_for('symptom_checker_page') }}" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg mb-2 text-center">
                <i class="fas fa-stethoscope mr-2"></i>{{ t.symptom_checker_link }}
            </a>
            <a href="{{ url_for('new_chat') }}" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg mb-4 text-center">
                <i class="fas fa-plus mr-2"></i>{{ t.new_chat_button }}
            </a>
            <div class="flex-grow overflow-y-auto pr-2" id="conversation-list"></div>
            <div class="mt-auto">
                <a href="{{ url_for('logout') }}" class="text-gray-400 hover:text-white"><i class="fas fa-sign-out-alt mr-2"></i>{{ t.logout_button }}</a>
            </div>
        </div>

        <!-- Main Chat -->
        <div class="flex-1 flex flex-col">
            <div class="flex-1 p-6 overflow-y-auto chat-body" id="message-container">
                <div id="language-selection-template" class="hidden">
                    <div class="text-center mt-20">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">{{ t.choose_language_header }}</h2>
                        <div class="flex justify-center space-x-4">
                            <button data-lang="en" class="lang-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg">English</button>
                            <button data-lang="or" class="lang-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg">‡¨ì‡¨°‡¨º‡¨ø‡¨Ü (Odia)</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <div class="p-4 bg-white border-t flex items-center space-x-3">
                <form id="messageArea" class="flex items-center flex-grow">
                    <input type="text" id="text" placeholder="{{ t.ask_placeholder }}" autocomplete="off" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="ml-2 bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                <!-- üé§ Speech Button -->
                <button id="micBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold p-3 rounded-full">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Chat Logic Variables ---
            const messageContainer = document.getElementById('message-container');
            const messageArea = document.getElementById('messageArea');
            const textInput = document.getElementById('text');
            const conversationList = document.getElementById('conversation-list');
            const languageSelectionTemplate = document.getElementById('language-selection-template');
            const micBtn = document.getElementById('micBtn');

            let activeConversationId = null;
            let chosenLanguageForNewChat = null;

            // --- Speech Recognition Setup ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = "en-US";
                recognition.interimResults = false;
                recognition.continuous = false;

                micBtn.addEventListener("click", () => {
                    recognition.start();
                    micBtn.classList.add("bg-red-700");
                });

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    textInput.value = transcript;
                    console.log("Transcribed Text:", transcript);
                    messageArea.requestSubmit(); // auto send
                };

                recognition.onend = () => {
                    micBtn.classList.remove("bg-red-700");
                };
            } else {
                micBtn.disabled = true;
                micBtn.title = "Speech Recognition not supported in this browser";
            }

            // --- Bot Speech Output ---
            function speakText(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    speechSynthesis.speak(utterance);
                }
            }

            // --- Display Messages ---
            function displayMessages(messages) {
                messageContainer.innerHTML = "";
                if (messages.length > 0) {
                    messages.forEach(function(message) {
                        const userHtml = `<div class="flex justify-end mb-4"><div class="bg-blue-500 text-white rounded-lg py-2 px-4 max-w-lg">${message.question}</div></div>`;
                        const botHtml = `<div class="flex justify-start mb-4"><div class="bg-gray-200 text-gray-800 rounded-lg py-2 px-4 max-w-lg">${message.answer}</div></div>`;
                        messageContainer.insertAdjacentHTML('beforeend', userHtml);
                        messageContainer.insertAdjacentHTML('beforeend', botHtml);
                    });
                }
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }

            function showLanguageSelection() {
                activeConversationId = null;
                chosenLanguageForNewChat = null;
                messageContainer.innerHTML = languageSelectionTemplate.innerHTML;
                messageArea.classList.add("hidden");
            }

            function loadConversation(conversationId) {
                activeConversationId = conversationId;
                chosenLanguageForNewChat = null;
                document.querySelectorAll('#conversation-list a').forEach(el => el.classList.remove('bg-gray-700'));
                document.querySelector(`[data-id='${conversationId}']`).classList.add('bg-gray-700');
                messageArea.classList.remove("hidden");
                fetch(`/get_conversation_history/${conversationId}`)
                    .then(response => response.json())
                    .then(data => displayMessages(data));
            }

            function loadConversationList(autoLoadFirst = true) {
                fetch("{{ url_for('get_conversations') }}")
                    .then(response => response.json())
                    .then(conversations => {
                        conversationList.innerHTML = "";
                        if (conversations.length > 0) {
                            conversations.forEach(function(convo, index) {
                                const convoHtml = `
                                <div class="flex items-center justify-between group">
                                    <a href="#" data-id="${convo.id}" class="block py-2 px-3 rounded-lg hover:bg-gray-700 truncate flex-grow">${convo.title}</a>
                                    <button class="delete-chat-btn text-gray-500 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100" data-id="${convo.id}" title="Delete Chat">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>`;
                                conversationList.insertAdjacentHTML('beforeend', convoHtml);
                                if (autoLoadFirst && index === 0) {
                                    loadConversation(convo.id);
                                }
                            });
                        } else if (autoLoadFirst) {
                            showLanguageSelection();
                        }
                    });
            }

            // --- Events ---
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('lang-btn')) {
                    chosenLanguageForNewChat = event.target.getAttribute('data-lang');
                    messageContainer.innerHTML = `<div class="text-center text-gray-500 mt-10">{{ t.ask_first_question }}</div>`;
                    messageArea.classList.remove("hidden");
                    textInput.focus();
                }

                if (event.target.closest('#conversation-list a')) {
                    event.preventDefault();
                    loadConversation(event.target.closest('a').getAttribute('data-id'));
                }

                if (event.target.closest('.delete-chat-btn')) {
                    event.stopPropagation();
                    const conversationId = event.target.closest('button').getAttribute('data-id');
                    if (confirm("Are you sure you want to delete this chat permanently?")) {
                        fetch(`/delete_conversation/${conversationId}`, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if(data.success) {
                                    if (activeConversationId === conversationId) {
                                        window.location.href = "{{ url_for('new_chat') }}";
                                    } else {
                                        loadConversationList(false);
                                    }
                                } else {
                                    alert("Error: Could not delete the conversation.");
                                }
                            });
                    }
                }
            });

            messageArea.addEventListener('submit', async function(event) {
                event.preventDefault();
                const rawText = textInput.value;
                if (rawText.trim() === "") return;

                const formData = new FormData();
                formData.append('msg', rawText);
                if (!activeConversationId && chosenLanguageForNewChat) {
                    formData.append('lang', chosenLanguageForNewChat);
                }

                const userHtml = `<div class="flex justify-end mb-4"><div class="bg-blue-500 text-white rounded-lg py-2 px-4 max-w-lg">${rawText}</div></div>`;
                messageContainer.insertAdjacentHTML('beforeend', userHtml);
                messageContainer.scrollTop = messageContainer.scrollHeight;
                textInput.value = "";

                const botBubbleId = `bot-bubble-${Date.now()}`;
                const botHtml = `<div class="flex justify-start mb-4"><div id="${botBubbleId}" class="bg-gray-200 text-gray-800 rounded-lg py-2 px-4 max-w-lg"><span class="typing-cursor"></span></div></div>`;
                messageContainer.insertAdjacentHTML('beforeend', botHtml);
                messageContainer.scrollTop = messageContainer.scrollHeight;

                try {
                    const response = await fetch("{{ url_for('get_bot_response') }}", {
                        method: 'POST',
                        body: formData
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    const botBubble = document.getElementById(botBubbleId);
                    botBubble.innerHTML = "";

                    let botText = "";

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) {
                            if (!activeConversationId) {
                                loadConversationList(true);
                            }
                            if (botText) speakText(botText); // üîä speak final bot text
                            break;
                        }
                        const chunk = decoder.decode(value, { stream: true });
                        botText += chunk;
                        botBubble.insertAdjacentHTML('beforeend', chunk);
                        messageContainer.scrollTop = messageContainer.scrollHeight;
                    }
                } catch (error) {
                    console.error("Streaming error:", error);
                    document.getElementById(botBubbleId).innerHTML = "<p class='text-red-500'>Sorry, an error occurred.</p>";
                }
            });

            // --- Init ---
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('new') === 'true') {
                showLanguageSelection();
                loadConversationList(false);
            } else {
                loadConversationList(true);
            }
        });
    </script>
</body>
</html>
